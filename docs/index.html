<script>
  const BOARD_SIZE = 10;
  const TOTAL_TILES = BOARD_SIZE * BOARD_SIZE;
  let positions = [];
  let currentPlayer = 0;
  let skipTurns = [];
  let numPlayers = 1;
  let isMuted = false;

  const TILE_EFFECTS = {
    4: "ğŸ– Snack! Forward 2 tiles",
    8: "ğŸ’¦ Mud puddle! Go back 1 tile",
    13: "ğŸ¦‹ Distracted! Skip next turn",
    19: "ğŸ¿ï¸ Squirrel! Forward 3 tiles",
    23: "âœ¨ Magic tile! Go to end",
    31: "ğŸªµ Tripped! Go back 2 tiles",
    44: "ğŸ© Treat stash! Forward 4 tiles",
    56: "ğŸ¾ Found a friend! Skip forward 1 tile",
    72: "ğŸª™ Lost a toy! Go back 3 tiles",
    88: "ğŸš« Fence! Skip next turn",
    95: "ğŸŒŸ Zoomies! Forward 5 tiles"
  };

  const board = document.getElementById("board");
  const message = document.getElementById("message");
  const menuContainer = document.getElementById("menu-container");
  const controls = document.getElementById("controls");

  const rollSound = document.getElementById("roll-sound");
  const winSound = document.getElementById("win-sound");
  const tileSound = document.getElementById("tile-sound");
  const menuMusic = document.getElementById("menu-music");

  function toggleMusic() {
    isMuted = !isMuted;
    menuMusic.muted = isMuted;
    document.getElementById("mute-button").textContent = isMuted ? "ğŸ”ˆ Unmute Music" : "ğŸ”‡ Mute Music";
  }

  function adjustVolume() {
    const volume = document.getElementById("volume-slider").value;
    menuMusic.volume = volume;
  }

  function drawBoard() {
    board.innerHTML = "";
    for (let i = 0; i < TOTAL_TILES; i++) {
      const tile = document.createElement("div");
      tile.className = "tile";
      tile.id = `tile-${i}`;
      tile.innerHTML = `<div>${i + 1}</div>`;

      if (TILE_EFFECTS[i]) {
        const effect = document.createElement("div");
        effect.className = "special";
        effect.textContent = TILE_EFFECTS[i];
        tile.appendChild(effect);
      }

      positions.forEach((pos, index) => {
        if (pos === i) {
          tile.classList.add("active");
          const icon = document.createElement("div");
          icon.className = "player";
          icon.textContent = index === 0 ? "ğŸ•" : "ğŸ©";
          tile.appendChild(icon);
        }
      });

      board.appendChild(tile);
    }

    const finalTile = document.getElementById(`tile-${TOTAL_TILES - 1}`);
    if (positions[currentPlayer] === TOTAL_TILES - 2) {
      finalTile.classList.add("flash");
      finalTile.style.animation = "flashTile 1s infinite";
    } else {
      finalTile.classList.remove("flash");
      finalTile.style.animation = "";
    }
  }

  function startGame(players) {
    numPlayers = players;
    positions = new Array(players).fill(0);
    skipTurns = new Array(players).fill(false);
    currentPlayer = 0;
    menuContainer.style.display = "none";
    board.style.display = "grid";
    controls.style.display = "block";
    drawBoard();
    showStatus();
  }

  function rollDice() {
    if (!isMuted) rollSound.play();

    if (skipTurns[currentPlayer]) {
      message.textContent = `Player ${currentPlayer + 1} was distracted! Turn skipped. ğŸ¦‹`;
      skipTurns[currentPlayer] = false;
      nextPlayer();
      return;
    }

    const roll = Math.floor(Math.random() * 6) + 1;
    const currentPos = positions[currentPlayer];
    const targetPos = Math.min(currentPos + roll, TOTAL_TILES - 1);

    message.textContent = `Player ${currentPlayer + 1} rolled a ${roll}!`;

    animateMove(currentPos, targetPos, () => {
      applyTileEffects(targetPos);
    });
  }

  function animateMove(start, end, callback) {
    let step = start;
    const interval = setInterval(() => {
      if (step === end) {
        clearInterval(interval);
        callback();
        return;
      }
      step += 1;
      positions[currentPlayer] = step;
      drawBoard();
      const tile = document.getElementById(`tile-${step}`);
      const paw = document.createElement("div");
      paw.className = "paw";
      paw.textContent = "ğŸ¾";
      tile.appendChild(paw);
      setTimeout(() => paw.classList.add("fade"), 300);
    }, 200);
  }

  function applyTileEffects(pos) {
    let target = pos;
    const effect = TILE_EFFECTS[pos];

    if (effect) {
      if (!isMuted) tileSound.play();
      message.textContent += ` ${effect}`;
      if (effect.includes("Forward 2")) target = Math.min(target + 2, TOTAL_TILES - 1);
      if (effect.includes("Forward 3")) target = Math.min(target + 3, TOTAL_TILES - 1);
      if (effect.includes("Forward 4")) target = Math.min(target + 4, TOTAL_TILES - 1);
      if (effect.includes("Forward 5")) target = Math.min(target + 5, TOTAL_TILES - 1);
      if (effect.includes("Go back 1")) target = Math.max(target - 1, 0);
      if (effect.includes("Go back 2")) target = Math.max(target - 2, 0);
      if (effect.includes("Go back 3")) target = Math.max(target - 3, 0);
      if (effect.includes("Skip")) skipTurns[currentPlayer] = true;
      if (effect.includes("Go to end")) target = TOTAL_TILES - 1;
    }

    positions[currentPlayer] = target;
    drawBoard();

    if (target === TOTAL_TILES - 1) {
      if (!isMuted) winSound.play();
      message.textContent = `ğŸ‰ Player ${currentPlayer + 1} reached the park and wins! ğŸ¶`;
      launchConfetti();
      controls.style.display = "block";
    } else {
      showStatus();
      nextPlayer();
    }
  }

  function nextPlayer() {
    currentPlayer = (currentPlayer + 1) % numPlayers;
  }

  function showStatus() {
    const tilesLeft = TOTAL_TILES - 1 - positions[currentPlayer];
    message.textContent += `\nPlayer ${currentPlayer + 1}, you need ${tilesLeft} more tile${tilesLeft > 1 ? "s" : ""}.`;
  }

  function restartGame() {
    startGame(numPlayers);
  }

  function showMenu() {
    location.reload();
  }

  function launchConfetti() {
    const confettiScript = document.createElement("script");
    confettiScript.src = "https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js";
    confettiScript.onload = () => {
      confetti({
        particleCount: 200,
        spread: 100,
        origin: { y: 0.6 }
      });
    };
    document.body.appendChild(confettiScript);
  }
</script>

<style>
  @keyframes flashTile {
    0% { background-color: #fff1cd; }
    50% { background-color: #ffe08a; }
    100% { background-color: #fff1cd; }
  }
  .fade {
    opacity: 0;
    transition: opacity 1s ease;
  }
</style>
